---
title: 'An Introduction to Tidy R Spatial Packages: Incorporating Historic Sociodemographic
  Data from the US Census and Visualizing Geographic Distributions'
author: "Stephen Uong & Christina Mehranbod"
date: "2024-06-12"
output: html_document
---


# A. Load Packages

First, you must sign up to get a Census API key: https://api.census.gov/data/key_signup.html
```{r packages}
library(sf)
library(tidyverse)
library(tidycensus)
library(ipums)

# census_api_key("INSERT API KEY", install = TRUE)
#this is christina's but delete later
census_api_key("0d1515194f46f009f34f94afcbf045315abdbfbd", install = TRUE)

```

# B. Import Data
## Recent Census data
You can get a list of variables using tidycensus. 

You can get a list of variables from the Dicennial Census or the American Community Survey. Since we are interested in the year 2021, let's use the American Community Survey. We will choose the 5-year ACS estimates because they tend to be more stable than 1 year estimates. 
### Explore data
```{r census_explore}
variables_2021 <- load_variables(2021, "acs5", cache = TRUE)

View(variables_2021)

# library(knitr)
```


### Import using get_acs(): A snapshot of 2021
To download ACS data, we need three pieces of information. 

- First, what do we want our geography to be? What's our unit of analysis? 
For this we have decided to use the Census tracts of New York State. See a full list of available geographies here: https://walker-data.com/tidycensus/articles/basic-usage.html#geography-in-tidycensus

- Second, what variables do we want? We can pull those directly in using the same command line. We can even give it our own titles. 

- Third, what year of data do we want? There's room for that too! 


```{r census}

#what variables on the census tract level? 
library(tidyverse)
variables_tract <- variables_2021 %>%
  filter(geography=="tract")

#let's use median income in the past 12 months B07011_001 and educational attainment (B16010_001, B16010_002, B16010_015, B16010_028, B16010_041)

acs_data <- get_acs(geography = "tract",
                    variables = c(hhincome = "B07011_001",
                                  total_education = "B16010_001", 
                                  education_lessthanhs= "B16010_002", 
                                  education_hs = "B16010_015", 
                                  education_somecollege = "B16010_028", 
                                  education_bachelors = "B16010_041"),
                    state="NY",
                    year=2021,
                    output = "wide")

# Convert educational attainment counts to percentages
acs_data <- acs_data %>%
  mutate(
    perc_lessthanhs = (education_lessthanhsE / total_educationE),
    perc_hs = (education_hsE / total_educationE),
    perc_somecollege = (education_somecollegeE / total_educationE),
    perc_bachelors = (education_bachelorsE / total_educationE)
  )

#this command brings in the data as a dataframe, which means there is no geometry attached
class(acs_data)

#Explore data
summary(acs_data[, c("perc_lessthanhs", "perc_hs", "perc_somecollege", "perc_bachelors")])

#Histogram for distribution of pooulation with less than high school education across census tracts
histogram <- ggplot(acs_data, aes(x = perc_lessthanhs)) +
  geom_histogram(binwidth = 0.03, fill = "lightblue", color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Distribution of Population with Less Than High School Education",
       x = "Percentage",
       y = "Frequency")

histogram

# Boxplot for percentage of population with a  high school degree across census tracts
boxplot <- ggplot(acs_data, aes(y = perc_lessthanhs)) +
  geom_boxplot(fill = "blue", color = "black", alpha = 0.5) +
  theme_minimal() +
  labs(title = "Boxplot of Population with Less Than High School Education",
       y = "Percentage")


#Bar plots for percentages

# Reshape the data for easier plotting
# Reshape the data for easier plotting
education_data <- acs_data %>%
  select(GEOID, perc_lessthanhs, perc_hs, perc_somecollege, perc_bachelors) %>%
  pivot_longer(cols = starts_with("perc_"), names_to = "education_level", values_to = "proportion")

print(head(education_data))
summary(education_data$proportion)


# Bar plot for educational attainment percentages
#HELP: WHY ARE MY PROPORTION VALUES SO WEIRD
barplot <- ggplot(education_data, aes(x = education_level, y = proportion, fill = education_level)) +
  geom_col(color = "black", alpha = 0.7) +
  theme_minimal() +
  labs(title = "Educational Attainment Proportions",
       x = "Education Level",
       y = "Proportion") +
  theme(legend.position = "none")


#to also bring in geometries, modify the command to bring in geometries
acs_data_geo <- get_acs(
  geography = "tract",
  variables = c(hhincome = "B19013_001",
                total_education = "B16010_001", 
                education_lessthanhs= "B16010_002", 
                education_hs = "B16010_015", 
                education_somecollege = "B16010_028", 
                education_bachelors = "B16010_041"),
  state = "NY",
  year = 2021,
  output = "wide", 
  geometry = TRUE)

#using base R to plot

#Plot median household income

#first NY state
plot(st_geometry(acs_data_geo), col = NA, border = 'grey')

#then median household income
plot(acs_data_geo['hhincomeE'], add = TRUE, main = "Median Household Income by Census Tract in NY (2021)",
     col = hcl.colors(5, rev = TRUE))

#FIX THESE LABELS AND LEGEND - base R sucks but it's something
# Add a legend
legend("bottomleft", legend = levels(cut(acs_data_geo$hhincomeE, breaks = 5)), title = "Income", cex = 0.8)

#this isn't the best way to plot (we'll show better ways) but just to show that we have a map!
```

## Range of Data: Median Household Income from 2009 to 2021

```{r range}

# Define the years of interest
years <- 2009:2021 

#define the variables from above

variables <- c(hhincome = "B19013_001")

#download data for multiple years

# Function to download ACS data for a given year
get_acs_data <- function(year) {
  get_acs(
    geography = "tract",
    variables = variables,
    state = "NY",
    year = year,
    output = "wide",
    geometry = TRUE
  ) %>%
    mutate(year = year)  # Add a column for the year
}

# Download data for all years and combine into one data frame
acs_data_list <- lapply(years, get_acs_data)
acs_data_all_years <- bind_rows(acs_data_list)

View(acs_data_all_years)

# Check the structure of the combined data
str(acs_data_all_years)

#plotting median household income over the years

#there are XX (INSERT NUMBER) census tracts so let's aggregate and plot averages

average_income <- acs_data_all_years %>%
  group_by(year) %>%
  summarise(avg_hhincome=mean(hhincomeE, na.rm=TRUE))

income_overtime <- ggplot(average_income, aes(x=year, y=avg_hhincome))+
  geom_line(color="blue") +
  geom_point(color="blue")+
  theme_minimal()+
  labs(title="Average Median Household Income Over Time in NY (2009-2021)", 
       x="Year", 
       y= "Average Median Household Income")

income_overtime


```

You can also map these! But we'll do this later. 
 

## CDC PLACES Data (health outcomes)

The [PLACES data](https://www.cdc.gov/places/index.html) was prepared by the Centers for Disease Control and Prevention (CDC), Robert Wood Johnson Foundation, and the CDC Foundation.

```{r places}
places_prelim <- sf::st_read('data/places2023/places2023.shp') # For some reason it's just a few states- need to double check this
library(readr)
places_prelim_df <- readr::read_csv('data/places2023.csv')
```

# C. Clean Data
## Census
```{r}

```

## PLACES
```{r}
places_prelim_df %>% head() %>% View()

places_cvd <- places_prelim_df %>% 
  dplyr::filter(MeasureId == 'CHD' & StateAbbr == 'NY') %>% # measureid
  dplyr::transmute(GEOID = LocationName,
                   state = StateAbbr, # stateabbr
                   chd_prev = Data_Value) # data_value
```

## Merge Data
```{r}
merged <- acs_data_geo %>% 
  dplyr::left_join(places_cvd, by = 'GEOID')
```


# D. Exploratory Data Analysis
```{r}
# to do separate plots for income
# to do: add numeric (text) summaries too

library(tidyverse)
merged_long_noinc <- merged %>% 
  tidyr::pivot_longer(cols = -c(GEOID, NAME, state, geometry, hhincomeE, hhincomeM),
                      names_to = 'variable_name',
                      values_to = 'value') 
merged_long_noinc %>% 
  ggplot(aes(y = value, x = 1)) + 
  geom_violin() +
  geom_boxplot(width = 0.2) +
  facet_grid(. ~ variable_name)


```


# E. Mapping

## E. Customizing Maps: Labels, Arrows, Colors and More!

```{r mapping_custom}
merged %>% names()
merged_long <- merged %>% 
  tidyr::pivot_longer(cols = -c(GEOID, NAME, state, geometry),
                      names_to = 'variable_name',
                      values_to = 'value') 

merged_long %>% head() %>% view()

# boundaries only
merged %>% 
  ggplot() +
  geom_sf() +
  theme_void()

# add in one variable
  # to do: change lower color (e.g., white)
merged %>% 
  ggplot() +
  geom_sf(aes(fill = total_educationE)) +
  theme_void()

# add in north arrow and scalebar
library(ggspatial)
merged %>% 
  ggplot() +
  geom_sf(aes(fill = total_educationE)) +
  theme_void() +
  ggspatial::annotation_north_arrow() +
  ggspatial::annotation_scale()

# add in all variables
merged_long %>% 
  ggplot() +
  geom_sf(aes(fill = value)) +
  theme_void() +
  facet_wrap(vars(variable_name), ncol = 3) +
  ggspatial::annotation_north_arrow() +
  ggspatial::annotation_scale()

```
